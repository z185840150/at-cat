/** Created by chameleon <magic.alone.k@gmail.com>
 * ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
 * │                                                                                                                                                        │
 * │                                      ;XBX3                                                                                                             │
 * │                                     X@3;5@@r                                                       ;995                                                │
 * │                                     @@    9@        :riSS9S@@@@@@Bi                              9@@G9B@s                                              │
 * │                             B@@@B;   @B    @A:5GA9BX93S5s,@@:   ;iB@@                           @@     @@                                              │
 * │                            @@  :9@@   @B:sB@BG3;rB9AA;    @r     ,r B@,            ;r35G9AGAGA5X@X :   @A     5@@@@S                                   │
 * │                            @@     B@,;B@@rr;    @rs: @@   B@  @@ B@  B@      :5X@@@BBXAS533s5rrX@r9B@@@@Br  X@A;: r@@                                  │
 * │                             @@;   r@@X:  A59@B ;@9@B:@B    @@        5@    B@@@BSs;           ,S5;    S5;B@@@r      @3                                 │
 * │                              r@BB@B:   ;@;3: @@ ;BXBB;      B@9:    A@9  B@B r;    S3        @@;ri@B        i@@r  X@B                                  │
 * │                               ,@@s     s@5@B @B               SBAB@@@;  @@   B;    rB       :@5 @XX@ :@@XBX   s@@@B:                                   │
 * │                              9@,        ;XAABs                  9@@r   @@     95sr55:        :B@BB@  @9 rr3@   r@X                                     │
 * │                             9@                               9@@@;     @5       ::                   @B:@B3@    ,@                                     │
 * │                            :@:  i33s53r                  5@@@Xr       ;@s                             9A59B      @9                                    │
 * │                            @@  B;    :rB;                ,:@@          @@                              ,r;,;i5;  @B                                    │
 * │                            @X rG        @                   @B         S@: 9@                        :B;      Si @X                                    │
 * │                            @X  @        B               @;  ;@          B@  @B          AA           @:        G @;                                    │
 * │                            @@   93;  :rB;  5r          @@    @r          A@r 5@BSr;;r5@@@r           X3       9 @@                                     │
 * │                            ;@s   ,rsr3r    A@@Ar;,,rS@@X    5@            :@@;  rABBBBS:              95;;;rsi B@                                      │
 * │                             B@;              rB@@@@BG;     ;@5              r@@A:                       ;;;   @@:                                      │
 * │                              X@9                          G@i                  9@@@S,                       A@S                                        │
 * │                               ,@@5                     r@@@           :9r          @@@@@@BX3r;,       ;rSB@@@@;                                        │
 * │                                X@@@@Ar:           ,3X@@@sr@@        ,@@@@@A5GXAA5r9@s   ;39BB@@@@@@@@@@@BS,  r@@                                       │
 * │                               @@   rB@@@@@@@@@@@@@@@9;     @@@@@@@@@@@@@@@@B@BB9G@@:                           @@                                      │
 * │                              @@          ,;;;;,:            B@:      sX ;       G@  :                           @@                                     │
 * │                             @@                              :@@       ;BX;  ;i3B@@@@B                            @@                                    │
 * │                            5@r                             9B@@@@@@@@@@@@@@@@@@@X                                r@r                                   │
 * │                            @@                                 3@r    ,@@@@B   @@                                  @@                                   │
 * │                      rBX: 9@                                   @@      :s:   ,@A                                  ,@GABBBs                             │
 * │                  S@:r@B@@ @@                                   5@;           @@                                    @@; :@@B;                           │
 * │                  :@@@@@@@9@r                                    @@           @@                                    S@   :3;@3                          │
 * │                     ,: :;@@                                     @@          i@i                                     @B   B@@:                          │
 * │                          @B                                     r@;         @@                                      @@@BB@G                            │
 * │                         s@9                                     :@@         @@;;rrr;;;;::   ::;;;;;;r;;;;,: ;;ri3s3;@@, :                              │
 * │                         r@B@@@BB9X@@B9XB@@@@@@@@BGSX@@9GB@B@B@@@B@9         r3SXAXAXGG9X@@@BAGXBBBBBXBGA9A@@@X5S99993s                                 │
 * │                                 BX@@@@;          9@@@@@B                               @BB@9@5          B@B@BB@                                        │
 * │                                9@    @@,;,       @B   5@r;;                        S9S@@    @@      r9SS@B   :@;                                       │
 * │                                9@    ;5r3X@;     @5    33r5@@                     @9        @@     B@         @:                                       │
 * │                                A@:       ,@5     @B        @@                     @Brr;rs33s@@     X@i;r;is3iB@:                                       │
 * │                                 9599A9GSS5;      r95AGA9GSSr                        ;rrrirr;,        ;rririrr;                                         │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │                                                          ____ ____ ___     ___  _    ____ ____ ____      _  _ ____ _  _ ____ ____    ___  _  _ ____    │
 * │                                                          | __ |  | |  \    |__| |    |___ |__  |__       |\ | |___ |  | |___ |__/    |__| |  | | __    │
 * │                                                          |__| |__| |__/    |__| |___ |___ ___| ___| ,    | \| |___  \/  |___ |  \    |__| |__| |__|    │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │                                                                                                                 __ .  ..__..  ..___.   .___.__..  .    │
 * │                                                                                                                /  `|__||__||\/||__ |   |__ |  ||\ |    │
 * │                                                                                                                \__.|  ||  ||  ||___|___|___|__|| \|    │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │ Description: Program entry file.                                                                                                                       │
 * │ Author: Chameleon <magic.alone.k@gmail.com>                                                                                                            │
 * │ Version: 1.0.0.0                                                                                                                                       │
 * │ Company: HeFei Parity Ltd.                                                                                                                             │
 * ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
 */

import * as BABYLON from 'babylonjs'
import 'babylonjs-materials'
import 'babylonjs-loaders'
import './lib/fur-material'
import './lib/star-material'

import SceneLoading from './scenes/SceneLoading'
import Scenehouse from './scenes/SceneHouse'

import TargetMaker from './lib/cat-maker/src/target-maker' // eslint-disable-line
import {Game, CatMaker, CatMesh, Gene, CatGene, User} from './lib/@cat/index' // eslint-disable-line

const DEBUG = false // 控制是否游戏中渲染Debug层

class MainGame extends Game {
  initBefore () {
    if (window && window.location && window.location.search) {
      const reg = new RegExp(`(^|&)token=([^&]*)(&|$)`, 'i')
      const r = window.location.search.substr(1).match(reg)

      if (r) this.user = new User(unescape(r[2]))
      else throw new Error('错误的提交参数！')
    } else throw new Error('不支持的运行环境！')
  }

  initAfter () {
    // 初始化渲染摄像机
    this.camera = new BABYLON.ArcRotateCamera('main-camera', 1, 0.8, 10, new BABYLON.Vector3(0, 0, 0), this.scene)
    this.camera.setPosition(new BABYLON.Vector3(0, 0, 10))
    this.camera.setTarget(BABYLON.Vector3.Zero())
    // this.camera.attachControl(this.canvas, true)

    // 初始化主灯光以及阴影发生器
    this.light = new BABYLON.DirectionalLight('main-light', new BABYLON.Vector3(-1, -2, -1), this.scene)
    this.light.position = new BABYLON.Vector3(20, 50, 20)
    this.light.intensity = 0.7
    this.shadowGenerator = new BABYLON.ShadowGenerator(2048, this.light)
    // this.shadowGenerator.useBlurExponentialShadowMap = true
    // this.shadowGenerator.useCloseExponentialShadowMap = true
    this.shadowGenerator.useBlurExponentialShadowMap = true
    this.shadowGenerator.useKernelBlur = true
    this.shadowGenerator.blurKernel = 64

    // 初始化渲染管线
    this.pipeline = new BABYLON.DefaultRenderingPipeline('DEFAULT_PIPELINE', true, this.scene, [this.camera], true)

    this.pipeline.samples = 4 // 多采样抗锯齿 1~4 默认：1
    this.pipeline.fxaaEnabled = true // 快速抗锯齿，默认：false
    this.pipeline.imageProcessing.toneMappingEnabled = false // Tone Mapping, default false
    this.pipeline.imageProcessing.contrast = 1 // Camera contrast, range 1-4, default 1
    this.pipeline.imageProcessing.exposure = 3 // Camera exposure, range 1-4, default 1
    this.pipeline.bloomEnabled = true // Bloom, default false
    this.pipeline.bloomKernel = 80 // Kernel, range 1-500, default 64
    this.pipeline.bloomWeight = 0.8 // Weight
    this.pipeline.bloomThreshold = 0.2 // Threshold
    this.pipeline.bloomScale = 0.5 // Scale

    // 初始化生成器
    this._catMaker = new CatMaker(this)
    // 初始化所有猫
    this._cat = new CatMesh(this)
  }

  startAfter () {
    // this.__loadCatTargetMaker()
    // return
    let sceneLoading = new SceneLoading(this)
    let sceneHouse = new Scenehouse(this)
    sceneLoading.__loadHouseScene = () => {
      sceneLoading.__guiTextLoadingProgressText('连接网络')
      this.__getUserCats() // 获取用户猫数据
        // 转为JSON基因
        .then(res => res.json())
        // 根据基因创建 CatMesh
        .then(json => {
          sceneLoading.__guiTextLoadingProgressText('提取基因')
          for (let i = 0; i < Object.keys(json).length; i++) {
            let {hash, gene} = json[i].catGene
            this.cat.genes[hash] = new CatGene(gene)
          }
        })
        // CatMesh 加载资源
        .then(() => sceneLoading.__guiTextLoadingProgressText('生成器初始化'))
        .then(() => this.cat.loadAssetsAsync())
        // 加载环境场景资源
        .then(() => sceneLoading.__guiTextLoadingProgressText('生成环境'))
        .then(() => sceneHouse.loadAssetsAsync(p => {}))
        // 构建 CatMesh 网格
        .then(() => sceneLoading.__guiTextLoadingProgressText('获取基因控制范围'))
        // CatMaker 读取网格目标文件
        .then(() => this.catMaker.loadTargetsAsync())
        // CatMaker 重构目标网格
        .then(() => sceneLoading.__guiTextLoadingProgressText('匹配基因'))
        .then(() => this.catMaker.build(this.cat))
        .then(() => {
          console.log(this.cat.hash)
          this.cat.meshs.cat_body.setVerticesData(BABYLON.VertexBuffer.PositionKind, this.cat.positions[this.cat.hash])
          this.cat.meshs.cat_body.visibility = 1
          sceneHouse.run()
          sceneLoading.__disposeGUI()
          allReady = true
        })
        .then(() => {})
    }
    sceneLoading.loadAssetsAsync(p => {}).then(scene => scene.run())
  }

  /**
   * 连接后端并获取猫的数据
   *
   * @returns
   * @memberof AtCatGame
   */
  __getUserCats () {
    return fetch('http://192.168.3.2:8081/api/cat/myCat', {
      headers: { 'content-type': 'application/json' },
      method: 'POST',
      body: JSON.stringify({ 'token': this.user.token })
    }).catch(() => {
      this.engine.dispose()
      document.removeChild(this.canvas)
      throw new Error('无效令牌')
    })
  }

  /**
   * 解码基因JSON
   *
   * @param {SceneLoading} loading 读取场景
   * @memberof AtCatGame
   */
  __decodeGene (loading, json, cb) {
    loading.__guiTextLoadingProgressText('解码基因原型')
    json.map(d => {
      // this.cat.genes.set(d.catGene.hash, new CatGene(d.catGene.gene))
      this.cat.genes[d.catGene.hash] = new CatGene(d.catGene.gene)
      // this.cat.postions[d.catGene.hash] = [].concat(this.cat.basePosition)
    })
    cb()
  }

  /**
   * 读取房屋场景资源
   *
   * @param {SceneLoading} loading 场景
   * @memberof AtCatGame
   */
  _loadSceneHouseAssets (loading) {
    loading.__guiTextLoadingProgressText('生成环境结构')
  }

  __loadCatTargetMaker () {
    BABYLON.SceneLoader.ImportMeshAsync(
      '', './static/assets/resources/cat/babylon/',
      'cat-target.babylon', this.scene).then(({meshes, skeletons}) => {
      let names = []
      this.camera.dispose()
      this.camera = new BABYLON.FreeCamera('Default-Camera', new BABYLON.Vector3(0, 0, 10), this.scene)
      this.camera.setTarget(BABYLON.Vector3.Zero())
      this.camera.attachControl(this.canvas, true)
      // console.log(meshes[10].getVerticesData(BABYLON.VertexBuffer.PositionKind))
      meshes.map(({name}, i) => { if (!(['cat', 'cat_eye_left', 'cat_eye_right', 'cat_body', 'cat_eye_left_glass', 'cat_eye_right_glass'].includes(name))) names.push(name) })
      let str = ''
      this.scene.getMeshByName('cat_body').getVerticesData(BABYLON.VertexBuffer.PositionKind).map(v => {
        str += `${v}|`
      })
      // names.map(name => {
      //   str += `*${name}\n`
      //   str += new TargetMaker(this.scene.getMeshByName('cat_body'), this.scene.getMeshByName(name)).build()
      // })
      console.log(str)
    })
  }
}

const touch = require('touchjs')

let allReady = false

window.addEventListener('DOMContentLoaded', () => {
  window.game = new MainGame(document.getElementById('renderCanvas'))
  window.game.start(DEBUG)
  touch.on(document.body, 'swipeleft', () => {
    if (allReady) changeCatIndex(window.game.cat.index + 1)
  })
  touch.on(document.body, 'swiperight', () => {
    if (allReady) changeCatIndex(window.game.cat.index - 1)
  })
})

function changeCatIndex (index) {
  console.log(index, Object.keys(window.game.cat.genes))
  if (index < 0) return
  if (index > Object.keys(window.game.cat.genes).length - 1) return
  console.log(index)

  window.game.cat.index = index

  window.game.catMaker.build(window.game.cat).then(() => {
    window.game.cat.meshs.cat_body.setVerticesData(BABYLON.VertexBuffer.PositionKind, window.game.cat.positions[window.game.cat.hash])
    window.game.cat.meshs.cat_body.visibility = 1
  })
}
