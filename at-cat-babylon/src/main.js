/** Created by chameleon <magic.alone.k@gmail.com>
 * ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
 * │                                                                                                                                                        │
 * │                                      ;XBX3                                                                                                             │
 * │                                     X@3;5@@r                                                       ;995                                                │
 * │                                     @@    9@        :riSS9S@@@@@@Bi                              9@@G9B@s                                              │
 * │                             B@@@B;   @B    @A:5GA9BX93S5s,@@:   ;iB@@                           @@     @@                                              │
 * │                            @@  :9@@   @B:sB@BG3;rB9AA;    @r     ,r B@,            ;r35G9AGAGA5X@X :   @A     5@@@@S                                   │
 * │                            @@     B@,;B@@rr;    @rs: @@   B@  @@ B@  B@      :5X@@@BBXAS533s5rrX@r9B@@@@Br  X@A;: r@@                                  │
 * │                             @@;   r@@X:  A59@B ;@9@B:@B    @@        5@    B@@@BSs;           ,S5;    S5;B@@@r      @3                                 │
 * │                              r@BB@B:   ;@;3: @@ ;BXBB;      B@9:    A@9  B@B r;    S3        @@;ri@B        i@@r  X@B                                  │
 * │                               ,@@s     s@5@B @B               SBAB@@@;  @@   B;    rB       :@5 @XX@ :@@XBX   s@@@B:                                   │
 * │                              9@,        ;XAABs                  9@@r   @@     95sr55:        :B@BB@  @9 rr3@   r@X                                     │
 * │                             9@                               9@@@;     @5       ::                   @B:@B3@    ,@                                     │
 * │                            :@:  i33s53r                  5@@@Xr       ;@s                             9A59B      @9                                    │
 * │                            @@  B;    :rB;                ,:@@          @@                              ,r;,;i5;  @B                                    │
 * │                            @X rG        @                   @B         S@: 9@                        :B;      Si @X                                    │
 * │                            @X  @        B               @;  ;@          B@  @B          AA           @:        G @;                                    │
 * │                            @@   93;  :rB;  5r          @@    @r          A@r 5@BSr;;r5@@@r           X3       9 @@                                     │
 * │                            ;@s   ,rsr3r    A@@Ar;,,rS@@X    5@            :@@;  rABBBBS:              95;;;rsi B@                                      │
 * │                             B@;              rB@@@@BG;     ;@5              r@@A:                       ;;;   @@:                                      │
 * │                              X@9                          G@i                  9@@@S,                       A@S                                        │
 * │                               ,@@5                     r@@@           :9r          @@@@@@BX3r;,       ;rSB@@@@;                                        │
 * │                                X@@@@Ar:           ,3X@@@sr@@        ,@@@@@A5GXAA5r9@s   ;39BB@@@@@@@@@@@BS,  r@@                                       │
 * │                               @@   rB@@@@@@@@@@@@@@@9;     @@@@@@@@@@@@@@@@B@BB9G@@:                           @@                                      │
 * │                              @@          ,;;;;,:            B@:      sX ;       G@  :                           @@                                     │
 * │                             @@                              :@@       ;BX;  ;i3B@@@@B                            @@                                    │
 * │                            5@r                             9B@@@@@@@@@@@@@@@@@@@X                                r@r                                   │
 * │                            @@                                 3@r    ,@@@@B   @@                                  @@                                   │
 * │                      rBX: 9@                                   @@      :s:   ,@A                                  ,@GABBBs                             │
 * │                  S@:r@B@@ @@                                   5@;           @@                                    @@; :@@B;                           │
 * │                  :@@@@@@@9@r                                    @@           @@                                    S@   :3;@3                          │
 * │                     ,: :;@@                                     @@          i@i                                     @B   B@@:                          │
 * │                          @B                                     r@;         @@                                      @@@BB@G                            │
 * │                         s@9                                     :@@         @@;;rrr;;;;::   ::;;;;;;r;;;;,: ;;ri3s3;@@, :                              │
 * │                         r@B@@@BB9X@@B9XB@@@@@@@@BGSX@@9GB@B@B@@@B@9         r3SXAXAXGG9X@@@BAGXBBBBBXBGA9A@@@X5S99993s                                 │
 * │                                 BX@@@@;          9@@@@@B                               @BB@9@5          B@B@BB@                                        │
 * │                                9@    @@,;,       @B   5@r;;                        S9S@@    @@      r9SS@B   :@;                                       │
 * │                                9@    ;5r3X@;     @5    33r5@@                     @9        @@     B@         @:                                       │
 * │                                A@:       ,@5     @B        @@                     @Brr;rs33s@@     X@i;r;is3iB@:                                       │
 * │                                 9599A9GSS5;      r95AGA9GSSr                        ;rrrirr;,        ;rririrr;                                         │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │                                                          ____ ____ ___     ___  _    ____ ____ ____      _  _ ____ _  _ ____ ____    ___  _  _ ____    │
 * │                                                          | __ |  | |  \    |__| |    |___ |__  |__       |\ | |___ |  | |___ |__/    |__| |  | | __    │
 * │                                                          |__| |__| |__/    |__| |___ |___ ___| ___| ,    | \| |___  \/  |___ |  \    |__| |__| |__|    │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │                                                                                                                 __ .  ..__..  ..___.   .___.__..  .    │
 * │                                                                                                                /  `|__||__||\/||__ |   |__ |  ||\ |    │
 * │                                                                                                                \__.|  ||  ||  ||___|___|___|__|| \|    │
 * │                                                                                                                                                        │
 * ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
 * │ Description: Program entry file.                                                                                                                       │
 * │ Author: Chameleon <magic.alone.k@gmail.com>                                                                                                            │
 * │ Version: 1.0.0.0                                                                                                                                       │
 * │ Company: HeFei Parity Ltd.                                                                                                                             │
 * ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
 */

import * as BABYLON from 'babylonjs'
import 'babylonjs-materials'
import 'babylonjs-loaders'
import './lib/fur-material'
import './lib/star-material'

import SceneLoading from './scenes/SceneLoading'
import Scenehouse from './scenes/SceneHouse'

import TargetMaker from './lib/cat-maker/src/target-maker'

import {Game, CatMaker, CatMesh, Gene, CatGene} from './lib/@cat/index'

const SHADOW_GENERATOR_SIZE = 512 // 阴影发生器采样率
const DEBUG = true // 控制是否游戏中渲染Debug层

class AtCatGame extends Game {
  initOverride () {
    // 初始化渲染摄像机
    this.camera = new BABYLON.ArcRotateCamera('MAIN_CAMERA', 1, 0.8, 10, new BABYLON.Vector3(0, 0, 0), this.scene)
    this.camera.setPosition(new BABYLON.Vector3(0, 0, 10))
    this.camera.setTarget(BABYLON.Vector3.Zero())
    // this.camera.attachControl(this.canvas, true)

    // 初始化主灯光以及阴影发生器
    this.light = new BABYLON.PointLight('MAIN_LIGHT', new BABYLON.Vector3(0, 1, 0), this.scene)
    this.light.intensity = 0.7
    this.shadowGenerator = new BABYLON.ShadowGenerator(SHADOW_GENERATOR_SIZE, this.light)
    this.shadowGenerator.useBlurExponentialShadowMap = true
    this.shadowGenerator.useCloseExponentialShadowMap = true

    // 初始化渲染管线
    this.pipeline = new BABYLON.DefaultRenderingPipeline('DEFAULT_PIPELINE', true, this.scene, [this.camera], true)

    this.pipeline.samples = 4 // 多采样抗锯齿 1~4 默认：1
    this.pipeline.fxaaEnabled = true // 快速抗锯齿，默认：false
    this.pipeline.imageProcessing.toneMappingEnabled = false // Tone Mapping, default false
    this.pipeline.imageProcessing.contrast = 1 // Camera contrast, range 1-4, default 1
    this.pipeline.imageProcessing.exposure = 1.25 // Camera exposure, range 1-4, default 1
    this.pipeline.bloomEnabled = true // Bloom, default false
    this.pipeline.bloomKernel = 84 // Kernel, range 1-500, default 64
    this.pipeline.bloomWeight = 0.6 // Weight
    this.pipeline.bloomThreshold = 0.15 // Threshold
    this.pipeline.bloomScale = 0.45 // Scale
  }

  startOverride () {
    new SceneLoading(this)
      .loadAssetsAsync(p => {})
      .then(loading => {
        loading.__loadHouseScene = () => {
          loading.__guiTextLoadingProgressText('连接网络')
          this.__connect2GetCatData()
            .then(res => res.json())
            .then(j => setTimeout(() => this.__decodeGene(loading, j, () => {
              console.log(j)
              setTimeout(() => {
                loading.__guiTextLoadingProgressText('搭建环境结构')
                const houseScene = new Scenehouse(this)
                houseScene.loadAssetsAsync(p => {})
                  .then(() => loading.__guiTextLoadingProgressText('获取基本形态'))
                  .then(() => this.cat.loadAssetsAsync()) // Cat Mesh 获取资源
                  .then(() => {
                    loading.__guiTextLoadingProgressText('获取基因形态')
                    this.catMaker.loadTargets(maker => {
                    // 开始生成猫模型

                      loading.__guiTextLoadingProgressText('基因网格化')
                      console.log('cat: ', this.cat)
                      console.log('cat: ', this.cat.meshs, this.cat.genes)
                      console.log('cat: ', this.cat.meshs['body'])
                      // BABYLON.SceneLoader.ImportMeshAsync('cat_body',
                      //   './static/assets/resources/cat/babylon/',
                      //   'cat.babylon', this.scene)
                      //   .then(({meshes, skeletons}) => {
                      //     houseScene.run()
                      //     this.scene.beginWeightedAnimation(skeletons[0], 20, 150, 1, true, 1)
                      //   })
                      this.catMaker.build(this.cat)
                        .then(() => {
                          this.cat.index = 0
                          let hash = Object.keys(this.cat.postions)[this.cat.index]

                          this.cat.meshs['body'].setVerticesData(BABYLON.VertexBuffer.PositionKind, this.cat.postions[hash])
                          this.cat.meshs['body'].visibility = 1
                          houseScene.run()
                        })
                    })
                  })
              }, 0)
            }), 0))
            .catch(() => {})
        }
        loading.run()
      })
  }

  /**
   * 连接后端并获取猫的数据
   *
   * @returns
   * @memberof AtCatGame
   */
  __connect2GetCatData () {
    return fetch('http://127.0.0.1:8081/api/cat/myCat', {
      headers: { 'content-type': 'application/json' },
      method: 'POST',
      body: JSON.stringify({ 'token': '094a2bc2-a214-46bc-9a8b-3b1b7dab4708' })
    })
  }

  /**
   * 解码基因JSON
   *
   * @param {SceneLoading} loading 读取场景
   * @memberof AtCatGame
   */
  __decodeGene (loading, json, cb) {
    loading.__guiTextLoadingProgressText('解码基因原型')
    json.map(d => {
      // this.cat.genes.set(d.catGene.hash, new CatGene(d.catGene.gene))
      this.cat.genes[d.catGene.hash] = new CatGene(d.catGene.gene)
      // this.cat.postions[d.catGene.hash] = [].concat(this.cat.basePosition)
    })
    cb()
  }

  /**
   * 读取房屋场景资源
   *
   * @param {SceneLoading} loading 场景
   * @memberof AtCatGame
   */
  _loadSceneHouseAssets (loading) {
    loading.__guiTextLoadingProgressText('生成环境结构')
  }

  __loadCatTargetMaker () {
    BABYLON.SceneLoader.ImportMeshAsync(
      '', './static/assets/resources/cat/babylon/',
      'cat-target.babylon', this.scene).then(({meshes, skeletons}) => {
      // const names = []
      this.camera.dispose()
      this.camera = new BABYLON.FreeCamera('Default-Camera', new BABYLON.Vector3(0, 0, 10), this.scene)
      this.camera.setTarget(BABYLON.Vector3.Zero())
      this.camera.attachControl(this.canvas, true)
      console.log(meshes[10].getVerticesData(BABYLON.VertexBuffer.PositionKind))
      // meshes.map(({name}, i) => { if (!(['cat', 'cat_eye_left', 'cat_eye_right', 'cat_body'].includes(name))) names.push(name) })
      // let str = ''
      // names.map(name => {
      //   str += `*${name}\n`
      //   str += new TargetMaker(this.scene.getMeshByName('cat_body'), this.scene.getMeshByName(name)).build()
      // })
      // console.log(str)
    })
  }
}

window.game = new AtCatGame() // 全局注册游戏
window.addEventListener('DOMContentLoaded', () => { window.game.start(DEBUG) })
